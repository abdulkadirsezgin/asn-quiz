<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ASN Quiz Player</title>
  <link rel="stylesheet" href="./style.css"/>
</head>
<body>
<div class="wrap" style="max-width:720px">

  <div class="card" id="joinCard">
    <div class="big">KatÄ±l</div>
    <div class="small kv" id="gidLbl">-</div>
    <div style="margin-top:10px">
      <input id="name" placeholder="Ä°smin"/>
      <button class="primary" id="btnJoin" style="width:100%;margin-top:10px;">Join</button>
    </div>
    <div class="small" style="margin-top:10px;">Mr.Sezgin baÅŸlatÄ±nca soru gelir.</div>
  </div>

  <div class="card" id="qCard" style="display:none;">
    <div class="row">
      <div class="pill huge" id="t">20.0</div>
      <div class="pill small" id="qIndex">Soru</div>
    </div>

    <div style="margin-top:12px" class="progress">
      <div class="fill" id="fill"></div>
    </div>

    <div class="qtext" id="qText">-</div>

    <div class="answers">
      <button class="choice choiceBtn" id="c0"><div class="badge cA">A</div><div id="ct0">-</div></button>
      <button class="choice choiceBtn" id="c1"><div class="badge cB">B</div><div id="ct1">-</div></button>
      <button class="choice choiceBtn" id="c2"><div class="badge cC">C</div><div id="ct2">-</div></button>
      <button class="choice choiceBtn" id="c3"><div class="badge cD">D</div><div id="ct3">-</div></button>
    </div>

    <div class="small" id="msg" style="margin-top:10px"></div>
  </div>

  <div class="card" id="waitCard" style="display:none;">
    <div class="big">Beklemedeâ€¦</div>
    <div class="small" id="waitMsg">Mr.Sezgin sonraki adÄ±ma geÃ§ince gÃ¼ncellenecek.</div>
    <div class="hr"></div>
    <div class="big">Top 4</div>
    <div id="top"></div>
  </div>

</div>
<div class="winnerOverlay" id="winnerOv">
  <div class="winnerCard">
    <div class="glow"></div>
    <div class="confetti" id="confetti"></div>

    <div class="winnerTitle">KSSTB'nin Saklan'an YÄ±ldÄ±zÄ±</div>
    <div class="winnerName" id="winnerName">-</div>
    <div class="winnerSub small kv" id="winnerMeta">-</div>

    <div style="margin-top:14px">
      <button id="winnerClose">Kapat</button>
    </div>
  </div>
</div>

<script>
  const API_BASE = "https://asn-quiz.abdulkadir-sezginn.workers.dev";
  const $ = id => document.getElementById(id);
const QUESTION_MS = 20000; // 20 saniye

  const u = new URL(location.href);
  const gameId = (u.searchParams.get("game") || "").toUpperCase();
  $("gidLbl").textContent = "Oyun: " + (gameId || "-");

  let playerId = localStorage.getItem("p_id_"+gameId) || "";
  let playerToken = localStorage.getItem("p_tok_"+gameId) || "";
  let lastAnsweredQ = Number(localStorage.getItem("p_lastq_"+gameId) || "-1");
  let answeredThisQuestion = false;
  let currentQIndex = -1;
  let serverEndsAt = null;     // st.endsAt
let lastLeftMs = QUESTION_MS;

let rafId = null;


  async function api(path, method="GET", body=null){
    const r = await fetch(API_BASE + path, {
      method,
      headers: {"Content-Type":"application/json"},
      body: body ? JSON.stringify(body) : null
    });
    if(!r.ok) throw new Error(await r.text());
    return r.json();
  }

  function show(which){
    $("joinCard").style.display = which==="join" ? "" : "none";
    $("qCard").style.display = which==="q" ? "" : "none";
    $("waitCard").style.display = which==="wait" ? "" : "none";
  }
function startSmoothTimer() {
  if (rafId) return;

  let lastNow = performance.now();
  const tick = (now) => {
    const dt = Math.min(100, now - lastNow); // bÃ¼yÃ¼k sÄ±Ã§ramalarÄ± yumuÅŸat
    lastNow = now;

    // kalan sÃ¼reyi akÄ±cÄ± dÃ¼ÅŸÃ¼r
    lastLeftMs = Math.max(0, lastLeftMs - dt);

    // UI gÃ¼ncelle
    $("t").textContent = (lastLeftMs / 1000).toFixed(1);
   $("fill").style.width = (lastLeftMs / QUESTION_MS * 100).toFixed(0) + "%";



    rafId = requestAnimationFrame(tick);
  };

  rafId = requestAnimationFrame(tick);
}

function stopSmoothTimer() {
  if (rafId) cancelAnimationFrame(rafId);
  rafId = null;
}
  let winnerShown = false;

function showWinnerOverlay(w){
  if (!w) return;
  const ov = $("winnerOv");
  $("winnerName").textContent = w.name || "-";
  const c = (w.correct ?? 0);
  const t = ((w.scoreMs ?? 0)/1000).toFixed(1) + "s";
  $("winnerMeta").textContent = `${c}âœ“ â€¢ ${t}`;
  ov.style.display = "flex";
  spawnConfetti(90);
}

function hideWinnerOverlay(){
  $("winnerOv").style.display = "none";
  $("confetti").innerHTML = "";
}

$("winnerClose").onclick = hideWinnerOverlay;

function spawnConfetti(n=80){
  const box = $("confetti");
  box.innerHTML = "";
  const W = window.innerWidth;
  for(let i=0;i<n;i++){
    const el = document.createElement("i");
    const left = Math.random()*W;
    const dur = 2.2 + Math.random()*2.0;
    const delay = Math.random()*0.6;
    const size = 8 + Math.random()*10;
    el.style.left = left + "px";
    el.style.width = (size*0.6) + "px";
    el.style.height = size + "px";
    el.style.animationDuration = dur + "s";
    el.style.animationDelay = delay + "s";
    el.style.background = "rgba(255,255,255," + (0.5 + Math.random()*0.5) + ")";
    box.appendChild(el);
  }
}


  $("btnJoin").onclick = async ()=>{
    const name = $("name").value.trim();
    if(!gameId) return alert("Link hatalÄ±. ?game=XXXX yok.");
    if(!name) return alert("Ä°sim gir");
    const res = await api(`/api/game/${gameId}/join`, "POST", { name });
    playerId = res.playerId;
    playerToken = res.playerToken;
    localStorage.setItem("p_id_"+gameId, playerId);
    localStorage.setItem("p_tok_"+gameId, playerToken);
    show("wait");
  };

  async function send(choice){
    answeredThisQuestion = true;
    ["c0","c1","c2","c3"].forEach(id => $(id).disabled = true);

    $("msg").textContent = "GÃ¶nderiliyorâ€¦";
    try{
      await api(`/api/game/${gameId}/answer`, "POST", { playerId, playerToken, choice });
      $("msg").textContent = "GÃ¶nderildi âœ…";
      lastAnsweredQ = currentQIndex;
      localStorage.setItem("p_lastq_"+gameId, String(lastAnsweredQ));
    }catch(e){
      $("msg").textContent = "AlÄ±nmadÄ± (sÃ¼re bitmiÅŸ olabilir).";
    }
  }

  ["c0","c1","c2","c3"].forEach((id,i)=> $(id).onclick = ()=>send(i));

  async function poll(){
    if(!gameId){ show("join"); return; }
    if(!playerId){ show("join"); return; }

    const st = await api(`/api/game/${gameId}/state`);

    // top4 her durumda gÃ¶sterilsin
const topEl = $("top");
const top = st.top4 || [];
topEl.innerHTML = top.length
  ? top.map((p,i)=>{
      const t = ((p.scoreMs || 0) / 1000).toFixed(1) + "s";
      const c = (p.correct ?? 0);
      return `
        <div class="tableRow">
          <div class="rank">${i+1}. ${p.name}</div>
          <div class="kv">${c}âœ“ â€¢ ${t}</div>
        </div>`;
    }).join("")
  : "<div class='small'>-</div>";


    if(st.phase === "lobby"){
        stopSmoothTimer();
      show("wait");
      $("waitMsg").textContent = "Mr. Sezgin baÅŸlatÄ±nca soru gelir.";
      winnerShown = false;
hideWinnerOverlay();

      return;
    }

    if(st.phase === "leaderboard"){
        stopSmoothTimer();
      show("wait");
      $("waitMsg").textContent = "Skorlar gÃ¼ncellendi. Mr. Sezgin kÄ±sa sÃ¼re iÃ§erisinde devam edecek.";
      return;
    }

  if(st.phase === "finished"){
  stopSmoothTimer();
  show("wait");
  $("waitMsg").textContent = "Quiz bitti ðŸŽ‰";

  // Winner sadece bir kez gÃ¶sterilsin
  if (!winnerShown && st.top4 && st.top4[0]) {
    winnerShown = true;
    showWinnerOverlay(st.top4[0]);
  }
  return;
}


    if(st.phase === "question"){
      show("q");
      winnerShown = false;
hideWinnerOverlay();


      currentQIndex = st.qIndex ?? -1;

      // yeni soru geldiyse kilidi kaldÄ±r
      if(lastAnsweredQ !== currentQIndex){
        answeredThisQuestion = false;
      }

      $("qIndex").textContent = `Soru ${currentQIndex + 1}/${st.qTotal ?? 0}`;
      $("qText").textContent = st.q?.text || "-";
      (st.q?.choices || ["-","-","-","-"]).forEach((x,i)=> $("ct"+i).textContent = x);

      const endsAt = (typeof st.endsAt === "number") ? st.endsAt : (Date.now() + QUESTION_MS);

// serverEndsAt deÄŸiÅŸtiyse ya da ilk kez geldiyse, animasyonu serverâ€™a hizala
if (serverEndsAt !== endsAt) {
  serverEndsAt = endsAt;
  lastLeftMs = Math.max(0, serverEndsAt - Date.now());
}

// EÄŸer animasyon drift yaptÄ±ysa (Ã¶r: dondu), tekrar hizala
const computedLeft = Math.max(0, serverEndsAt - Date.now());
if (Math.abs(computedLeft - lastLeftMs) > 350) {
  lastLeftMs = computedLeft;
}

startSmoothTimer();


      const answered = answeredThisQuestion || (lastAnsweredQ === currentQIndex);
      ["c0","c1","c2","c3"].forEach(id => $(id).disabled = answered);

      if(!answered) $("msg").textContent = "";
      return;
    }
stopSmoothTimer();

    show("wait");
  }

  setInterval(()=>poll().catch(()=>{}), 200);
</script>
</body>
</html>
